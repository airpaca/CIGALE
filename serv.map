# Mapfile
# 
# WFS: 
# Ne définir le wfs_srs que dans la partie MAP > WEB > METADATA
# Il faut que la couche PostGIS soit en EPSG:4326
# Il faut créer les tables avec un OID
# 
# WMS:
# If faut absolument le param PROJECTION dans map

MAP

    # CONFIGURATION GENERALE
    # ##############################################################################################
    
    CONFIG "MS_ERRORFILE" "/tmp/ms_error.log"
    DEBUG 3

    # Paramètres généraux
    NAME "CIGALE"
    PROJECTION
        "init=epsg:2154"
    END
    IMAGETYPE png
    EXTENT 795500.0 6232500.0 801500.0 6238500.0
    SIZE 600 600
    

    WEB
        METADATA
            
            # WMS
            "wms_title"  "Consultation d’Inventaires Géolocalisés de qualité de l’Air et de L’Energie - WMS"
            "wms_abstract"  "Contact: Air PACA"
            "wms_encoding"  "utf-8"
            "wms_enable_request"  "*"
            "wms_include_items"      "all"
            "queryable"    "true"
            "wms_feature_info_mime_type" "text/html"
            "wms_srs"  "EPSG:4326 EPSG:2154 EPSG:3857 EPSG:3395"
            "wms_format" "image/png"
            "wms_keywordlist" "1487070000.0"
            
            # WFS
            "wfs_title"          "Consultation d’Inventaires Géolocalisés de qualité de l’Air et de L’Energie - WFS"
            "wfs_abstract"       "Contact: Air PACA"            
            "wfs_srs"            "EPSG:2154 EPSG:4326 EPSG:3857"
            "wfs_enable_request" "*"
            "wfs_getfeature_formatlist" "geojson"
            "gml_include_items" "all"
            "gml_featureid"     "ID"         

        END
    END

    # Formats de sortie autorisés pour le WFS
    OUTPUTFORMAT
        NAME "geojson"
        DRIVER "OGR/GEOJSON"
        MIMETYPE "application/json"
        FORMATOPTION "STORAGE=memory" # "STORAGE=stream"
        FORMATOPTION "FORM=SIMPLE"
    END 

    # COUCHES DES EPCI AVEC ET SANS POLLUANTS
    # ##############################################################################################
    
    # WMS EPCI
    LAYER 
        CONNECTIONTYPE postgis 
        NAME "epci" 
        TEMPLATE "fake.html"                       
        METADATA
          "wms_title" "epci"
          "wms_include_items" "siren_epci"
        END        
        CONNECTION INCLUDE "serv.conn" 
        PROCESSING "CLOSE_CONNECTION=DEFER"
        DATA "geom from cigale.epci_2154" 
        STATUS ON
        TYPE POLYGON 
        CLASS
            STYLE 
                OUTLINECOLOR 10 10 10
                WIDTH 2
                COLOR "#e4e4e4"
            END
        END
        DUMP TRUE        
    END      
 
    # WFS EPCI
    LAYER
        CONNECTIONTYPE postgis 
        NAME "epci_wfs"
        METADATA
            "wfs_title"         "epci_wfs"
            "gml_include_items" "all"
            "gml_featureid"     "ID"
        END        
        TYPE POLYGON
        STATUS ON
        CONNECTION INCLUDE "serv.conn" 
        PROCESSING "CLOSE_CONNECTION=DEFER"
        VALIDATION 
            'nom_abrege_polluant' "[A-Z0-9._%+-|'\(\)]"
        END        
        DATA "geom from (SELECT * FROM cigale.epci_poll WHERE nom_abrege_polluant = '%nom_abrege_polluant%') as a using unique gid"
        CLASS
            OUTLINECOLOR 10 10 10
            COLOR 200 255 0
        END 
    END 
    
    # WFS COMMUNES
    LAYER
        CONNECTIONTYPE postgis 
        NAME "comm_wfs"
        METADATA
            "wfs_title"         "comm_wfs"
            "gml_include_items" "all"
            "gml_featureid"     "ID"
            "wfs_enable_request" "*"
            "wfs_getfeature_formatlist" "geojson"
        END        
        TYPE POLYGON
        STATUS ON
        CONNECTION INCLUDE "serv.conn" 
        PROCESSING "CLOSE_CONNECTION=DEFER"
        VALIDATION 
            'siren_epci' "[A-Z0-9._%+-|'\(\)]"
            'nom_abrege_polluant' "[A-Z0-9._%+-|'\(\)]"
        END
        DATA "geom from (SELECT * FROM cigale.comm_poll WHERE nom_abrege_polluant = '%nom_abrege_polluant%' and siren_epci::text like '%siren_epci%') as a using unique gid"      
        CLASS
            OUTLINECOLOR 10 10 10
            COLOR 200 255 0
        END 
    END         
 
END